name: YouTube Downloader Ubuntu
on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube URL'
        required: true
        default: 'https://www.youtube.com/watch?v=kKgt_azwT0M'
      resolution:
        description: 'Resolution'
        required: true
        type: choice
        default: '1440'
        options: ['720', '1080', '1440']
      trim_enabled:
        description: 'Enable Trim?'
        type: boolean
        default: true
      start_time:
        description: 'Start (00:00:00)'
        default: '00:00:00'
      end_time:
        description: 'End (00:00:10)'
        default: '00:00:10'
      manual_cookies:
        description: 'Paste Netscape Cookies here'
        required: false

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup yt-dlp
        uses: AnimMouse/setup-yt-dlp@v3

      - name: Process Cookies
        env:
          RAW_COOKIES: ${{ github.event.inputs.manual_cookies }}
        run: |
          if [[ -n "$RAW_COOKIES" ]]; then
            echo "$RAW_COOKIES" > cookies.txt
            echo "USE_COOKIES=true" >> $GITHUB_ENV
          else
            echo "USE_COOKIES=false" >> $GITHUB_ENV
          fi

      - name: Install Cloudflare WARP
        run: |
          # Исправленный метод получения ключа GPG
          sudo mkdir -p /usr/share/keyrings
          wget -qO- https://pkg.cloudflareclient.com | sudo gpg --yes --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          sudo apt-get update && sudo apt-get install -y cloudflare-warp
          
          # Настройка и запуск
          warp-cli --accept-tos registration new
          warp-cli --accept-tos mode proxy
          warp-cli --accept-tos connect
          sleep 10
          # Проверка работы
          curl -sx socks5://localhost:40000 https://www.cloudflare.com | grep ip

      - name: Check Available Formats
        run: |
          COOKIE_ARG=""
          [[ "$USE_COOKIES" == "true" ]] && COOKIE_ARG="--cookies cookies.txt"
          
          echo "--- DEBUG: AVAILABLE FORMATS ---"
          yt-dlp $COOKIE_ARG \
            --user-agent "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" \
            --extractor-args "youtube:player_client=tv,web" \
            -F "${{ github.event.inputs.video_url }}"

      - name: Run Download
        run: |
          COOKIE_ARG=""
          [[ "$USE_COOKIES" == "true" ]] && COOKIE_ARG="--cookies cookies.txt"

          TRIM_ARG=""
          if [[ "${{ github.event.inputs.trim_enabled }}" == "true" ]]; then
            TRIM_ARG="--download-sections *${{ github.event.inputs.start_time }}-${{ github.event.inputs.end_time }}"
          fi
          
          # Мы принудительно используем только те форматы, которые ты видел в логах (vp9/av01)
          # Клиент 'tv' позволяет обойти PO Token для высоких разрешений
          yt-dlp \
            $COOKIE_ARG \
            $TRIM_ARG \
            --user-agent "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" \
            --extractor-args "youtube:player_client=tv;player_skip=configs" \
            --no-cache-dir \
            -f "bestvideo[height<=${{ github.event.inputs.resolution }}]+bestaudio/best" \
            --merge-output-format mp4 \
            -o "video.mp4" \
            "${{ github.event.inputs.video_url }}"

      - name: Upload
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: youtube-video
          path: video.mp4
          retention-days: 1
