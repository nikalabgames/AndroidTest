name: YouTube Downloader Windows
on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube URL'
        required: true
        default: 'https://www.youtube.com/watch?v=kKgt_azwT0M'
      resolution:
        description: 'Resolution'
        required: true
        type: choice
        default: '1440'
        options: ['720', '1080', '1440']
      trim_enabled:
        description: 'Enable Trim?'
        type: boolean
        default: true
      start_time:
        description: 'Start (00:00:00)'
        default: '00:00:00'
      end_time:
        description: 'End (00:00:10)'
        default: '00:00:10'
      manual_cookies:
        description: 'Paste Netscape Cookies here'
        required: false

jobs:
  download:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup yt-dlp
        uses: AnimMouse/setup-yt-dlp@v3
        with:
          ffmpeg: true

      - name: Process and Validate Cookies
        shell: bash
        env:
          RAW_COOKIES: ${{ github.event.inputs.manual_cookies }}
        run: |
          if [[ -n "$RAW_COOKIES" ]]; then
            # 'tr -d' removes Windows carriage returns that break the cookie file
            echo "$RAW_COOKIES" | tr -d '\r' > cookies.txt
            
            if grep -q "Netscape" cookies.txt && grep -q "youtube.com" cookies.txt; then
              echo "✅ Cookie file is valid Netscape format."
              echo "USE_COOKIES=true" >> $GITHUB_ENV
            else
              echo "❌ ERROR: Invalid cookie format."
              exit 1
            fi
          else
            echo "⚠️ No cookies provided."
            echo "USE_COOKIES=false" >> $GITHUB_ENV
          fi

      - name: Install & Start Cloudflare WARP
        shell: powershell
        run: |
          # Установка через winget (доступно на windows-latest)
          winget install --id Cloudflare.Warp --silent --accept-package-agreements --accept-source-agreements
          # Запуск сервиса (может занять время)
          Start-Process "C:\Program Files\Cloudflare\Cloudflare WARP\warp-svc.exe"
          Start-Sleep -s 10
          & "C:\Program Files\Cloudflare\Cloudflare WARP\warp-cli.exe" --accept-tos registration new
          & "C:\Program Files\Cloudflare\Cloudflare WARP\warp-cli.exe" --accept-tos connect

#      - name: Check Available Formats
#        shell: bash
#        run: |
#          COOKIE_ARG=""
#          if [[ "$USE_COOKIES" == "true" ]]; then
#            COOKIE_ARG="--cookies cookies.txt"
#          fi
#          
#          echo "--- AVAILABLE FORMATS FOR THIS VIDEO ---"
#          yt-dlp $COOKIE_ARG \
#            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" \
#            --extractor-args "youtube:player_client=android_vr,tv" \
#            -F "${{ github.event.inputs.video_url }}"
#          echo "----------------------------------------"

      - name: Run Download
        shell: bash
        run: |
          COOKIE_ARG=""
          if [[ "$USE_COOKIES" == "true" ]]; then
            COOKIE_ARG="--cookies cookies.txt"
          fi

          TRIM_ARG=""
          if [[ "${{ github.event.inputs.trim_enabled }}" == "true" ]]; then
            TRIM_ARG="--download-sections *${{ github.event.inputs.start_time }}-${{ github.event.inputs.end_time }}"
          fi

          # 1. Принудительно выводим сообщение, чтобы проверить, работают ли логи
          echo ">>> STARTING DOWNLOAD PROCESS <<<"
          
          # Мы используем клиент 'tv', так как он чаще всего отдает HD без PO Token.
          # Селектор "bestvideo[height<=?1440]+bestaudio/best" наиболее универсален.
          yt-dlp --verbose \
            $COOKIE_ARG \
            $TRIM_ARG \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" \
            --extractor-args "youtube:player_client=android_vr,tv;player_skip=configs" \
            --no-cache-dir \
            --fixup force \
            --write-thumbnail \
            --convert-thumbnails jpg \
            --print-to-file title metadata.txt \
            -f "bestvideo[height<=${{ github.event.inputs.resolution }}]+bestaudio/best[height<=1440]" \
            --merge-output-format mp4 \
            -o "video.mp4" \
            "${{ github.event.inputs.video_url }}"
          
           # 3. Создаем файл метаданных
           sed -i '1s/^/Title: /' metadata.txt
           echo "Resolution: ${{ github.event.inputs.resolution }}p" >> metadata.txt
           echo "URL: ${{ github.event.inputs.video_url }}" >> metadata.txt

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: youtube-package
          path: |
            video.mp4
            video.jpg
            metadata.txt
          retention-days: 1
